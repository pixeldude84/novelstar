<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NovelStar 1.1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap');

:root {
  --bg:     #c0c0c0;
  --face:   #d4d0c8;
  --light:  #ffffff;
  --dark:   #808080;
  --darker: #404040;
  --black:  #000000;
  --blue:   #000080;
  --sel:    #000080;
  --st:     #ffffff;
  --font:   'Share Tech Mono','Courier New',monospace;
  --ed:     'Courier New',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--black);font-family:var(--font);font-size:15px;height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;}

/* bevels */
.R{border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);}
.S{border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);}

/* button */
.btn{background:var(--face);color:var(--black);font-family:var(--font);font-size:14px;padding:5px 16px;cursor:pointer;border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);letter-spacing:.5px;white-space:nowrap;text-align:center;min-width:86px;}
.btn:active{border-color:var(--darker) var(--light) var(--light) var(--darker);padding:6px 15px 4px 17px;}
.btn.dflt{outline:2px solid var(--black);outline-offset:-4px;}

/* titlebar */
#titlebar{background:var(--blue);color:#fff;padding:4px 6px;font-size:16px;font-weight:bold;letter-spacing:1px;display:flex;align-items:center;gap:8px;flex-shrink:0;}
#tb-txt{flex:1;}
.twbtn{width:22px;height:20px;background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;color:var(--black);}

/* menubar */
#menubar{background:var(--face);border-bottom:1px solid var(--dark);display:flex;align-items:center;padding:1px 2px;flex-shrink:0;position:relative;z-index:300;}
.mnu{background:none;border:2px solid transparent;color:var(--black);font-family:var(--font);font-size:15px;padding:3px 10px;cursor:pointer;letter-spacing:.5px;position:relative;}
.mnu:hover,.mnu.open{background:var(--sel);color:#fff;border-color:transparent;}
.msep{width:1px;height:22px;background:var(--dark);margin:0 4px;border-right:1px solid var(--light);}
#proj-disp{flex:1;text-align:center;font-size:15px;color:var(--darker);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 8px;}

/* dropdown */
.dd{display:none;position:absolute;top:100%;left:0;background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);box-shadow:3px 3px 0 var(--darker);z-index:500;min-width:190px;padding:2px 0;}
.dd.open{display:block;}
.ddi{display:block;width:100%;background:none;border:none;color:var(--black);font-family:var(--font);font-size:14px;padding:5px 20px 5px 24px;cursor:pointer;text-align:left;letter-spacing:.5px;white-space:nowrap;}
.ddi:hover{background:var(--sel);color:#fff;}
.ddi:disabled{color:var(--dark);cursor:default;}
.ddi:disabled:hover{background:none;color:var(--dark);}
.ddsep{height:1px;background:var(--dark);border-bottom:1px solid var(--light);margin:3px 4px;}
.ddsc{float:right;color:var(--dark);font-size:12px;margin-left:20px;}
.ddi:hover .ddsc{color:#aaa;}

/* toolbar */
#toolbar{background:var(--face);border-bottom:2px solid var(--dark);display:flex;align-items:center;padding:3px 6px;gap:3px;flex-shrink:0;flex-wrap:wrap;}
.tbtn{background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);font-family:var(--font);font-size:14px;padding:3px 10px;cursor:pointer;color:var(--black);letter-spacing:.5px;}
.tbtn:active{border-color:var(--darker) var(--light) var(--light) var(--darker);padding:4px 9px 2px 11px;}
.tsep{width:1px;height:22px;background:var(--dark);border-right:1px solid var(--light);margin:0 4px;}
.tsel{font-family:var(--font);font-size:14px;padding:3px 6px;background:white;color:var(--black);border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);outline:none;cursor:pointer;}

/* main */
#main{display:flex;flex:1;overflow:hidden;background:var(--bg);gap:3px;padding:3px;}

/* left panel */
#lpanel{width:230px;background:var(--face);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);}
.phdr{background:var(--blue);color:#fff;padding:4px 8px;font-size:14px;font-weight:bold;letter-spacing:1px;flex-shrink:0;}
#chtree{flex:1;overflow-y:auto;background:white;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);margin:4px;}
#chtree::-webkit-scrollbar{width:16px;}
#chtree::-webkit-scrollbar-track{background:var(--face);}
#chtree::-webkit-scrollbar-thumb{background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);}
.chitem{user-select:none;}
.chlbl{display:flex;align-items:center;padding:4px 6px;cursor:pointer;font-size:14px;gap:5px;color:var(--black);background:white;}
.chlbl:hover{background:var(--sel);color:#fff;}
.chlbl .arr{font-size:10px;width:12px;}
.chlbl .cn{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:bold;}
.chlbl .cw{font-size:12px;color:var(--dark);}
.chlbl:hover .cw{color:#aaa;}
.sclist{display:none;}
.sclist.open{display:block;}
.scitm{display:flex;align-items:center;padding:3px 6px 3px 24px;cursor:pointer;font-size:13px;gap:5px;background:white;color:var(--black);}
.scitm:hover,.scitm.active{background:var(--sel);color:#fff;}
.scitm .sn{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.scitm .sw{font-size:12px;color:var(--dark);}
.scitm:hover .sw,.scitm.active .sw{color:#bbb;}
#lfoot{padding:5px 8px;font-size:13px;color:var(--darker);border-top:1px solid var(--dark);background:var(--face);flex-shrink:0;}
#lfoot b{color:var(--blue);}

/* editor area */
#edarea{flex:1;display:flex;flex-direction:column;overflow:hidden;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);background:var(--face);}
#schdr{background:var(--blue);color:#fff;padding:4px 10px;font-size:14px;letter-spacing:.5px;display:flex;align-items:center;gap:8px;flex-shrink:0;position:relative;}
#sclbl{flex:1;}
#sctgt{font-size:13px;opacity:.85;}

#edscroll{flex:1;overflow-y:auto;background:white;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);margin:4px;display:flex;justify-content:center;padding:30px 20px;user-select:text;-webkit-user-select:text;}
#edscroll::-webkit-scrollbar{width:16px;}
#edscroll::-webkit-scrollbar-track{background:var(--face);}
#edscroll::-webkit-scrollbar-thumb{background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);}

/* iframe editor */
#editor-frame{
  width:100%;max-width:700px;min-height:600px;
  border:none;background:transparent;display:block;
  flex-shrink:0;flex-grow:1;
}

/* right panel */
#rpanel{width:230px;background:var(--face);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);}
.rtabs{display:flex;background:var(--face);border-bottom:2px solid var(--dark);padding:3px 4px 0;gap:2px;}
.rtab{padding:4px 14px;font-family:var(--font);font-size:14px;cursor:pointer;color:var(--black);background:var(--bg);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);border-bottom:2px solid var(--face);position:relative;bottom:-2px;letter-spacing:.5px;}
.rtab.active{background:var(--face);border-bottom-color:var(--face);z-index:1;}
.rpane{display:none;flex:1;overflow-y:auto;padding:6px;flex-direction:column;gap:6px;}
.rpane.active{display:flex;}
.rpane::-webkit-scrollbar{width:16px;}
.rpane::-webkit-scrollbar-track{background:var(--face);}
.rpane::-webkit-scrollbar-thumb{background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);}
.nlbl{font-size:13px;font-weight:bold;color:var(--darker);padding:2px 0;}
.ntxt{border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);background:white;color:var(--black);font-family:var(--font);font-size:13px;padding:5px;resize:none;outline:none;width:100%;height:78px;line-height:1.5;user-select:text;}
.srow{display:flex;justify-content:space-between;align-items:center;font-size:13px;padding:3px 4px;border-bottom:1px solid var(--bg);}
.sl{color:var(--darker);}
.sv{font-weight:bold;color:var(--blue);font-size:15px;}
.sv.over{color:#c00;}
.pout{height:18px;background:white;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);margin:2px 0 6px;overflow:hidden;}
.pin{height:100%;background:var(--blue);transition:width .3s;display:flex;align-items:center;padding-left:4px;font-size:11px;color:#fff;white-space:nowrap;}
.pin.over{background:#c00;}

/* status bar */
#sbar{background:var(--face);border-top:2px solid var(--dark);display:flex;align-items:stretch;flex-shrink:0;height:30px;font-size:14px;}
.sbs{display:flex;align-items:center;padding:0 10px;gap:6px;border-right:2px solid var(--dark);border-left:1px solid var(--light);font-size:14px;}
.sbs:first-child{border-left:none;}
.sbl2{color:var(--darker);}
.sbv{font-weight:bold;color:var(--blue);font-family:var(--font);}
.sbv.over{color:#c00;}
#sbmod{margin-left:auto;color:#c00;font-size:14px;padding:0 10px;display:flex;align-items:center;}

/* splash */
#splash{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:900;}
#splash.hidden{display:none;}
.spwin{background:var(--face);border:3px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);width:460px;box-shadow:4px 4px 0 var(--darker);overflow:hidden;}
.sptb{background:var(--blue);color:#fff;padding:6px 10px;font-size:18px;font-weight:bold;letter-spacing:2px;display:flex;align-items:center;gap:8px;}
.spbody{padding:24px 28px;display:flex;flex-direction:column;gap:14px;align-items:center;}
.splogo{font-family:'VT323',monospace;font-size:58px;color:var(--blue);letter-spacing:4px;line-height:1;}
.sptag{font-size:15px;color:var(--darker);letter-spacing:1px;text-align:center;}
.spbtns{display:flex;gap:12px;margin-top:8px;}
.spver{font-size:13px;color:var(--dark);letter-spacing:1px;margin-top:4px;}

/* modal */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:1000;}
.mbg.hidden{display:none;}
.mwin{background:var(--face);border:3px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);min-width:420px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:4px 4px 0 var(--darker);}
.mwin::-webkit-scrollbar{width:16px;}
.mwin::-webkit-scrollbar-track{background:var(--face);}
.mwin::-webkit-scrollbar-thumb{background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);}
.mtb{background:var(--blue);color:#fff;padding:5px 10px;font-size:16px;font-weight:bold;letter-spacing:1px;display:flex;align-items:center;justify-content:space-between;}
.mxbtn{width:22px;height:20px;background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;color:var(--black);font-family:var(--font);font-weight:bold;}
.mbody{padding:18px 22px 14px;}
.fr{margin-bottom:12px;}
.fr label{display:block;font-size:14px;font-weight:bold;color:var(--black);margin-bottom:4px;}
.fr input,.fr select{width:100%;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);background:white;color:var(--black);font-family:var(--font);font-size:15px;padding:5px 8px;outline:none;user-select:text;}
.fr input:focus{outline:1px dotted var(--black);outline-offset:1px;}
.f2{display:flex;gap:12px;}
.f2 .fr{flex:1;}
.fhint{background:var(--bg);border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);padding:10px 12px;font-size:14px;color:var(--darker);margin-bottom:14px;line-height:1.7;}
.fhint b{color:var(--blue);}
.mact{display:flex;gap:10px;justify-content:flex-end;padding-top:10px;border-top:1px solid var(--dark);margin-top:12px;}

/* fullscreen */
#fsov{position:fixed;inset:0;background:#000;z-index:500;display:none;flex-direction:column;}
#fsov.active{display:flex;}
#fswrap{flex:1;overflow-y:auto;display:flex;justify-content:center;padding:60px 20px 40px;}
#fswrap::-webkit-scrollbar{width:6px;}
#fswrap::-webkit-scrollbar-thumb{background:#333;}
#fsed{width:100%;max-width:720px;min-height:100%;background:transparent;border:none;outline:none;font-family:'Courier New',monospace;font-size:20px;line-height:2;color:#fff;caret-color:#fff;white-space:pre-wrap;word-wrap:break-word;user-select:text;}
#fsed:empty::before{content:'Begin writing...';color:#555;font-style:italic;pointer-events:none;}
#fsbar{height:38px;background:#111;border-top:1px solid #333;display:flex;align-items:center;padding:0 20px;gap:20px;font-size:14px;color:#666;font-family:var(--font);letter-spacing:1px;}
.fv{color:#fff;font-size:16px;font-weight:bold;}
#fsexit{margin-left:auto;background:none;border:1px solid #444;color:#888;font-family:var(--font);font-size:13px;padding:4px 12px;cursor:pointer;letter-spacing:1px;}
#fsexit:hover{border-color:#888;color:#ccc;}

/* compile */
#cmodal{z-index:1100;}
#cmodal .mwin{min-width:580px;}

/* manuscript preview — styled to look like real pages */
#msprev{display:none;background:#e8e8e8;border:2px solid;border-color:var(--darker) var(--light) var(--light) var(--darker);padding:10px;margin-top:14px;max-height:360px;overflow-y:auto;}
#msprev::-webkit-scrollbar{width:16px;}
#msprev::-webkit-scrollbar-track{background:var(--face);}
#msprev::-webkit-scrollbar-thumb{background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);}
.mspage{background:white;width:650px;margin:0 auto 12px;padding:72px 72px 72px 72px;font-family:'Courier New',monospace;font-size:12px;line-height:2;color:#000;box-shadow:2px 2px 4px rgba(0,0,0,.15);position:relative;}
.mspage:last-child{margin-bottom:0;}
.ms-hdr-r{position:absolute;top:24px;right:72px;font-size:11px;color:#555;font-family:'Courier New',monospace;}
.ms-wc-r{position:absolute;top:72px;right:72px;font-size:12px;font-family:'Courier New',monospace;}
.ms-title-blk{margin-top:180px;text-align:center;line-height:2;}
.ms-ch-blk{margin-top:220px;text-align:center;line-height:2;margin-bottom:40px;}
.ms-para{text-indent:36px;margin:0;line-height:2;}
.ms-break{text-align:center;line-height:2;margin:0;}

/* spell/grammar checker panel */
#grammarbar{background:#fffff0;border-top:2px solid var(--dark);border-bottom:2px solid var(--dark);padding:3px 10px;font-size:13px;color:var(--darker);display:flex;align-items:center;gap:10px;flex-shrink:0;min-height:26px;flex-wrap:wrap;}
#grammarbar.clean{color:green;}
#grammarbar.issues{color:#8B0000;}
.gram-issue{display:inline-block;background:#fff3cd;border:1px solid #ffc107;border-radius:2px;padding:1px 6px;margin:1px 3px;font-size:12px;cursor:default;}
.gram-issue:hover{background:#ffe08a;}
.gram-lbl{font-weight:bold;margin-right:4px;}

#toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:var(--face);border:2px solid;border-color:var(--light) var(--darker) var(--darker) var(--light);color:var(--black);font-family:var(--font);font-size:15px;letter-spacing:1px;padding:8px 20px;z-index:9000;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap;box-shadow:3px 3px 0 var(--darker);}
#toast.show{opacity:1;}
.hidden{display:none!important;}
</style>
</head>
<body>

<div id="toast"></div>

<!-- SPLASH -->
<div id="splash">
  <div class="spwin">
    <div class="sptb"><span>&#9998;</span><span>NovelStar 1.1</span></div>
    <div class="spbody">
      <div class="splogo" style="font-size:36px;line-height:1.2;letter-spacing:2px;">
        <svg width="80" height="64" viewBox="0 0 80 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:0 auto 4px;">
          <!-- Typewriter body -->
          <rect x="8" y="20" width="64" height="36" rx="4" fill="#000080" stroke="#c0c0c0" stroke-width="2"/>
          <!-- Paper -->
          <rect x="22" y="6" width="36" height="22" rx="2" fill="white" stroke="#808080" stroke-width="1.5"/>
          <!-- Paper lines -->
          <line x1="27" y1="12" x2="53" y2="12" stroke="#d0d0d0" stroke-width="1"/>
          <line x1="27" y1="17" x2="53" y2="17" stroke="#d0d0d0" stroke-width="1"/>
          <line x1="27" y1="22" x2="45" y2="22" stroke="#d0d0d0" stroke-width="1"/>
          <!-- Platen roller -->
          <rect x="18" y="18" width="44" height="6" rx="3" fill="#404040" stroke="#c0c0c0" stroke-width="1.5"/>
          <!-- Keys row 1 -->
          <rect x="14" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="25" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="36" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="47" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="58" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <!-- Keys row 2 -->
          <rect x="14" y="44" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="25" y="44" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="36" y="44" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="47" y="44" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <rect x="58" y="44" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <!-- Space bar -->
          <rect x="20" y="54" width="40" height="6" rx="2" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
          <!-- Carriage return lever -->
          <line x1="8" y1="22" x2="4" y2="16" stroke="#c0c0c0" stroke-width="2"/>
          <circle cx="4" cy="15" r="2" fill="#c0c0c0"/>
        </svg>
        NOVELSTAR
      </div>
      <div class="sptag">Professional Novel Writing Software<br>Chrome &amp; Edge</div>
      <div class="spbtns">
        <button class="btn dflt" id="sp-new" style="font-size:16px;padding:7px 22px;">New Project</button>
        <button class="btn" id="sp-open" style="font-size:16px;padding:7px 22px;">Open File&hellip;</button>
      </div>
      <div class="spver">NovelStar 1.1 &nbsp;&middot;&nbsp; &copy; 2026</div>
    </div>
  </div>
</div>

<!-- NEW PROJECT MODAL -->
<div class="mbg hidden" id="npmodal">
  <div class="mwin">
    <div class="mtb"><span>&#9998; New Project</span><div class="mxbtn" id="np-x">&#x2715;</div></div>
    <div class="mbody">
      <div class="fr"><label>Author Name</label><input type="text" id="np-author" placeholder="Your full name" autocomplete="off"></div>
      <div class="fr"><label>Book Title</label><input type="text" id="np-title" placeholder="My Novel" autocomplete="off"></div>
      <div class="f2">
        <div class="fr"><label>Chapters</label><input type="number" id="np-ch" value="20" min="1" max="300"></div>
        <div class="fr"><label>Scenes / Chapter</label><input type="number" id="np-sc" value="3" min="1" max="30"></div>
      </div>
      <div class="fr"><label>Target Word Count</label><input type="number" id="np-wc" value="80000" min="100"></div>
      <div class="fhint" id="np-hint">Enter values above to see word-count targets.</div>
      <div class="mact">
        <button class="btn" id="np-cancel">Cancel</button>
        <button class="btn dflt" id="np-create">Create Project</button>
      </div>
    </div>
  </div>
</div>

<!-- COMPILE MODAL -->
<div class="mbg hidden" id="cmodal">
  <div class="mwin">
    <div class="mtb"><span>Compile &mdash; Shunn Manuscript Format</span><div class="mxbtn" id="cm-x">&#x2715;</div></div>
    <div class="mbody">
      <div class="f2">
        <div class="fr"><label>Author Name</label><input type="text" id="c-author" autocomplete="off"></div>
        <div class="fr"><label>Book Title</label><input type="text" id="c-title" autocomplete="off"></div>
      </div>
      <div class="fr"><label>Street Address <span style="font-weight:normal;color:#666;">(optional)</span></label><input type="text" id="c-addr1" placeholder="123 Main Street" autocomplete="off"></div>
      <div class="fr"><label>City, State ZIP <span style="font-weight:normal;color:#666;">(optional)</span></label><input type="text" id="c-addr2" placeholder="New York, NY 10001" autocomplete="off"></div>
      <div class="f2">
        <div class="fr"><label>Email <span style="font-weight:normal;color:#666;">(opt.)</span></label><input type="email" id="c-email" placeholder="you@email.com" autocomplete="off"></div>
        <div class="fr"><label>Phone <span style="font-weight:normal;color:#666;">(opt.)</span></label><input type="text" id="c-phone" placeholder="(555) 555-5555" autocomplete="off"></div>
      </div>
      <div id="msprev"></div>
      <div class="mact">
        <button class="btn" id="cm-close">Close</button>
        <button class="btn" id="cm-prev">Preview</button>
        <button class="btn dflt" id="cm-pdf">Create Manuscript PDF</button>
      </div>
    </div>
  </div>
</div>

<!-- FULLSCREEN -->
<div id="fsov">

<!-- AUTOSAVE PROMPT MODAL -->
<div class="mbg hidden" id="asmodal">
  <div class="mwin" style="min-width:380px;max-width:440px;">
    <div class="mtb"><span>&#9650; Auto-Save</span><div class="mxbtn" id="as-x">&#x2715;</div></div>
    <div class="mbody">
      <div class="fhint">
        <b>Enable Auto-Save?</b><br><br>
        NovelStar can automatically save your project every <b>60 seconds</b> while you write.<br><br>
        Auto-save requires a linked file (Save As first if this is a new project). You can toggle it anytime from the title bar.
      </div>
      <div class="mact">
        <button class="btn" id="as-no">Not Now</button>
        <button class="btn dflt" id="as-yes">Enable Auto-Save</button>
      </div>
    </div>
  </div>
</div>
  <div id="fswrap">
    <div id="fsed" contenteditable="true" spellcheck="true" lang="en-US"></div>
  </div>
  <div id="fsbar">
    <span>SCENE</span><span class="fv" id="fs-sc">0</span>
    <span>|</span><span>TOTAL</span><span class="fv" id="fs-tot">0</span>
    <span>|</span><span>TARGET</span><span class="fv" id="fs-tgt">&#8212;</span>
    <button id="fsexit">[ESC] EXIT FULLSCREEN</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;flex-direction:column;height:100vh;">

  <div id="titlebar">
    <svg width="20" height="16" viewBox="0 0 80 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
      <rect x="8" y="20" width="64" height="36" rx="4" fill="#4060c0" stroke="#ffffff" stroke-width="2"/>
      <rect x="22" y="6" width="36" height="22" rx="2" fill="white" stroke="#aaaaaa" stroke-width="1.5"/>
      <rect x="18" y="18" width="44" height="6" rx="3" fill="#222244" stroke="#ffffff" stroke-width="1.5"/>
      <rect x="14" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
      <rect x="25" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
      <rect x="36" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
      <rect x="47" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
      <rect x="58" y="34" width="8" height="7" rx="1" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
      <rect x="20" y="54" width="40" height="6" rx="2" fill="#d4d0c8" stroke="#808080" stroke-width="1"/>
    </svg>
    <span id="tb-txt">NovelStar 1.1</span>
    <label id="autosave-label" style="display:flex;align-items:center;gap:6px;font-size:13px;font-weight:normal;letter-spacing:.5px;cursor:pointer;color:#cce;margin-left:auto;user-select:none;" title="Auto-save every 60 seconds when a file is linked">
      <input type="checkbox" id="autosave-chk" style="width:14px;height:14px;cursor:pointer;accent-color:#6688ff;">
      Auto-Save
    </label>
    <span id="autosave-status" style="font-size:12px;color:#8af;opacity:0;transition:opacity 1s;margin-left:4px;"></span>
  </div>

  <div id="menubar">
    <!-- File menu with dropdown -->
    <button class="mnu" id="mnu-file">File</button>
    <div class="dd" id="dd-file">
      <button class="ddi" id="dd-new">New Project<span class="ddsc">Ctrl+N</span></button>
      <div class="ddsep"></div>
      <button class="ddi" id="dd-open">Open&hellip;<span class="ddsc">Ctrl+O</span></button>
      <div class="ddsep"></div>
      <button class="ddi" id="dd-save">Save<span class="ddsc">Ctrl+S</span></button>
      <button class="ddi" id="dd-saveas">Save As&hellip;<span class="ddsc">Ctrl+Shift+S</span></button>
      <div class="ddsep"></div>
      <button class="ddi" id="dd-compile">Compile Manuscript&hellip;</button>
    </div>
    <div class="msep"></div>
    <div id="proj-disp">&mdash; No Project Open &mdash;</div>
    <div class="msep"></div>
  </div>

  <div id="toolbar">
    <button class="tbtn" id="tb-left" title="Left">&#9665;&#8212;</button>
    <button class="tbtn" id="tb-ctr" title="Center">&#8212;|&#8212;</button>
    <button class="tbtn" id="tb-right" title="Right">&#8212;&#9655;</button>
    <div class="tsep"></div>
    <button class="tbtn" id="tb-tab">&#8594; Tab</button>
  </div>

  <div id="main">
    <div id="lpanel">
      <div class="phdr">Project Files</div>
      <div id="lpanel-btns" style="display:flex;gap:3px;padding:4px;background:var(--face);border-bottom:1px solid var(--dark);flex-shrink:0;">
        <button class="tbtn" id="lp-newsc" title="New Scene" style="flex:1;font-size:13px;padding:3px 5px;">+ Scene</button>
        <button class="tbtn" id="lp-delsc" title="Delete Scene" style="flex:1;font-size:13px;padding:3px 5px;">&#x2717; Del</button>
        <button class="tbtn" id="lp-rename" title="Rename Scene" style="flex:1;font-size:13px;padding:3px 5px;">Rename</button>
      </div>
      <div id="chtree"></div>
      <div id="lfoot">Words: <b id="lf-wc">0</b> / <b id="lf-tgt">&#8212;</b></div>
    </div>

    <div id="edarea">
      <div id="schdr">
        <span id="sclbl">Select a scene to begin writing</span>
        <span id="sctgt"></span>
      </div>
      <!-- Editor formatting toolbar -->
      <div id="edtoolbar" style="background:var(--face);border-bottom:2px solid var(--dark);display:flex;align-items:center;padding:3px 6px;gap:3px;flex-shrink:0;flex-wrap:wrap;">
        <button class="tbtn" id="tb-bold" style="font-weight:bold;" title="Bold">B</button>
        <button class="tbtn" id="tb-ital" style="font-style:italic;" title="Italic">I</button>
        <button class="tbtn" id="tb-ul" style="text-decoration:underline;" title="Underline">U</button>
        <div class="tsep"></div>
        <select class="tsel" id="tb-sz">
          <option value="14">14pt</option>
          <option value="16" selected>16pt</option>
          <option value="18">18pt</option>
          <option value="20">20pt</option>
          <option value="24">24pt</option>
        </select>
        <select class="tsel" id="tb-font">
          <option value="'Courier New',monospace" selected>Courier New</option>
          <option value="Georgia,serif">Georgia</option>
          <option value="'Times New Roman',serif">Times New Roman</option>
          <option value="Arial,sans-serif">Arial</option>
          <option value="Verdana,sans-serif">Verdana</option>
          <option value="'Palatino Linotype',serif">Palatino</option>
          <option value="Garamond,serif">Garamond</option>
          <option value="'Book Antiqua',serif">Book Antiqua</option>
        </select>
        <div style="flex:1;"></div>
        <button id="mnu-fs" title="Focus Mode" style="background:#1a1a6e;color:#fff;border:2px solid;border-color:#4444aa #000033 #000033 #4444aa;font-family:var(--font);font-size:13px;padding:3px 10px;cursor:pointer;letter-spacing:.5px;">&#x26F6; Focus Mode</button>
      </div>
      <div id="grammarbar"><span class="gram-lbl">&#10003; Spell/Grammar:</span><span id="gram-status">Select a scene to begin</span></div>
      <div id="edscroll">
        <iframe id="editor-frame"
          style="width:100%;max-width:700px;min-height:600px;border:none;background:transparent;display:block;flex-shrink:0;"
          src="about:blank"
          spellcheck="true"
        ></iframe>
      </div>
    </div>

    <div id="rpanel">
      <div class="rtabs">
        <div class="rtab active" data-tab="notes">Notes</div>
        <div class="rtab" data-tab="stats">Stats</div>
      </div>
      <div class="rpane active" id="tab-notes">
        <div class="nlbl">Scene Note:</div>
        <textarea class="ntxt" id="sc-note" placeholder="Notes for this scene..."></textarea>
        <div class="nlbl">Chapter Note:</div>
        <textarea class="ntxt" id="ch-note" placeholder="Notes for this chapter..."></textarea>
        <div class="nlbl">Project Note:</div>
        <textarea class="ntxt" id="pr-note" placeholder="Overall project notes..." style="height:90px;"></textarea>
      </div>
      <div class="rpane" id="tab-stats"></div>
    </div>
  </div>

  <div id="sbar">
    <div class="sbs"><span class="sbl2">Scene:</span><span class="sbv" id="sb-sc">0</span></div>
    <div class="sbs"><span class="sbl2">Chapter:</span><span class="sbv" id="sb-ch">0</span></div>
    <div class="sbs"><span class="sbl2">Total:</span><span class="sbv" id="sb-tot">0</span></div>
    <div class="sbs"><span class="sbl2">Target:</span><span class="sbv" id="sb-tgt">&#8212;</span></div>
    <div class="sbs"><span class="sbl2">Progress:</span><span class="sbv" id="sb-pct">&#8212;</span></div>
    <div id="sbmod" class="hidden">&#9679; UNSAVED</div>
  </div>
</div>

<input type="file" id="file-in" accept=".ns" style="display:none;">

<script>
'use strict';

const NS = {
  P: null,       // project
  cur: null,     // {ci, si}
  fh: null,      // file handle
  mod: false,
  autoSave: false,
  autoSaveTimer: null,
  AUTO_SAVE_INTERVAL: 60000, // 60 seconds

  init() {
    this.bindSplash();
    this.bindFileMenu();
    this.bindToolbar();
    this.bindLPanel();
    this.bindEditor();
    this.bindAutoSave();
    this.bindFS();
    this.bindCompile();
    this.bindRTabs();
    this.bindNPModal();
    this.bindFileInput();
    // Initialize the iframe editor (must come after DOM is ready)
    window.addEventListener('load', ()=>this.initEditorFrame());
    // Also try immediately in case load already fired
    if(document.readyState==='complete') this.initEditorFrame();
    document.addEventListener('keydown', e => {
      const c = e.ctrlKey||e.metaKey;
      if (e.key==='Escape') { this.exitFS(); this.closeDD(); }
      if (c&&e.key==='s'&&!e.shiftKey) { e.preventDefault(); this.save(); }
      if (c&&e.key==='S'&&e.shiftKey)  { e.preventDefault(); this.saveAs(); }
      if (c&&e.key==='n') { e.preventDefault(); this.doNew(); }
      if (c&&e.key==='o') { e.preventDefault(); this.openFile(); }
    });
    document.addEventListener('click', e => { if (!e.target.closest('#menubar')) this.closeDD(); });
  },

  // ── Splash ──
  bindSplash() {
    $('sp-new').onclick  = () => { $('splash').classList.add('hidden'); this.showNP(); };
    $('sp-open').onclick = () => { $('splash').classList.add('hidden'); this.openFile(); };
  },
  showApp() { document.getElementById('app').style.display = 'flex'; },

  // ── File Menu Dropdown ──
  bindFileMenu() {
    const mf=$('mnu-file'), dd=$('dd-file');
    mf.onclick = e => { e.stopPropagation(); const o=dd.classList.toggle('open'); mf.classList.toggle('open',o); };
    $('dd-new').onclick     = () => { this.closeDD(); this.doNew(); };
    $('dd-open').onclick    = () => { this.closeDD(); this.openFile(); };
    $('dd-save').onclick    = () => { this.closeDD(); this.save(); };
    $('dd-saveas').onclick  = () => { this.closeDD(); this.saveAs(); };
    $('dd-compile').onclick = () => { this.closeDD(); this.openCompile(); };
    $('mnu-fs').onclick     = () => this.enterFS();
  },
  closeDD() {
    document.querySelectorAll('.dd').forEach(d=>d.classList.remove('open'));
    document.querySelectorAll('.mnu').forEach(m=>m.classList.remove('open'));
  },
  doNew() { if (this.mod&&!confirm('Unsaved changes. New project?')) return; this.showNP(); },

  // ── New Project ──
  showNP() {
    this.showApp();
    $('npmodal').classList.remove('hidden');
    this.calcHint();
    setTimeout(()=>$('np-author').focus(),50);
  },
  bindNPModal() {
    ['np-ch','np-sc','np-wc'].forEach(id=>$(id).addEventListener('input',()=>this.calcHint()));
    $('np-create').onclick = ()=>this.createProject();
    $('np-cancel').onclick = ()=>this.cancelNP();
    $('np-x').onclick      = ()=>this.cancelNP();
    ['np-author','np-title','np-ch','np-sc','np-wc'].forEach(id=>
      $(id).addEventListener('keydown',e=>{ if(e.key==='Enter') this.createProject(); })
    );
  },
  cancelNP() {
    $('npmodal').classList.add('hidden');
    if (!this.P) { document.getElementById('app').style.display='none'; $('splash').classList.remove('hidden'); }
  },
  calcHint() {
    const ch=+$('np-ch').value||0, sc=+$('np-sc').value||0, wc=+$('np-wc').value||0;
    const ts=ch*sc, wps=ts>0?Math.round(wc/ts):0, wpc=ch>0?Math.round(wc/ch):0;
    $('np-hint').innerHTML=`<b>${ch}</b> chapters &times; <b>${sc}</b> scenes = <b>${ts}</b> total scenes<br>~<b>${wpc.toLocaleString()}</b> words/chapter &nbsp;&middot;&nbsp; ~<b>${wps.toLocaleString()}</b> words/scene`;
  },
  createProject() {
    const author=$('np-author').value.trim(), title=$('np-title').value.trim();
    const ch=+$('np-ch').value||1, sc=+$('np-sc').value||1, wc=+$('np-wc').value||0;
    if (!author) { alert('Please enter your name.'); $('np-author').focus(); return; }
    if (!title)  { alert('Please enter a book title.'); $('np-title').focus(); return; }
    const wps=(ch*sc)>0?Math.round(wc/(ch*sc)):0;
    const chapters=[];
    for(let c=0;c<ch;c++){
      const scenes=[];
      for(let s=0;s<sc;s++) scenes.push({name:`Scene ${s+1}`,content:'',note:''});
      chapters.push({name:`Chapter ${c+1}`,note:'',scenes});
    }
    this.P={version:'1.1',title,author,targetWords:wc,wordsPerScene:wps,projectNote:'',chapters};
    this.fh=null; this.cur=null; this.setMod(false);
    $('npmodal').classList.add('hidden');
    this.renderTree(); this.updatePD();
    if (chapters[0]?.scenes[0]) this.selectScene(0,0);
    this.toast('Project created!');
    setTimeout(()=>this.promptAutoSave(), 400);
  },

  // ── Tree ──
  renderTree() {
    const t=$('chtree'); t.innerHTML='';
    if (!this.P) return;
    this.P.chapters.forEach((ch,ci)=>{
      const open=this.cur?.ci===ci;
      const d=document.createElement('div'); d.className='chitem';
      d.innerHTML=`
        <div class="chlbl" data-ci="${ci}">
          <span class="arr">${open?'&#9660;':'&#9658;'}</span>
          <span class="cn">&#128193; ${esc(ch.name)}</span>
          <span class="cw">${this.chWC(ci)}</span>
        </div>
        <div class="sclist${open?' open':''}" id="sl-${ci}">
          ${ch.scenes.map((sc,si)=>`
            <div class="scitm${this.isCur(ci,si)?' active':''}" data-ci="${ci}" data-si="${si}">
              <span>&#128196;</span><span class="sn">${esc(sc.name)}</span>
              <span class="sw">${countW(sc.content)}</span>
            </div>`).join('')}
        </div>`;
      t.appendChild(d);
      d.querySelector('.chlbl').onclick=()=>{
        const sl=$(`sl-${ci}`), a=d.querySelector('.arr');
        sl.classList.toggle('open'); a.innerHTML=sl.classList.contains('open')?'&#9660;':'&#9658;';
      };
      d.querySelectorAll('.scitm').forEach(el=>{
        el.onclick=e=>{e.stopPropagation();this.selectScene(+el.dataset.ci,+el.dataset.si);};
        el.ondblclick=e=>{e.stopPropagation();this.renameScene(+el.dataset.ci,+el.dataset.si);};
      });
    });
    this.updFooter();
  },
  isCur(ci,si){return this.cur?.ci===ci&&this.cur?.si===si;},
  chWC(ci){return this.P?.chapters[ci].scenes.reduce((s,sc)=>s+countW(sc.content),0)||0;},
  totalWC(){return this.P?.chapters.reduce((s,ch)=>s+ch.scenes.reduce((a,sc)=>a+countW(sc.content),0),0)||0;},
  updFooter(){
    $('lf-wc').textContent=this.totalWC().toLocaleString();
    $('lf-tgt').textContent=this.P?this.P.targetWords.toLocaleString():'&#8212;';
  },

  // ── Select Scene ──
  selectScene(ci,si) {
    this.saveContent();
    this.cur={ci,si};
    const sc=this.P.chapters[ci].scenes[si], ch=this.P.chapters[ci];
    this.setEditorContent(sc.content || '');
    $('sclbl').textContent=`${ch.name}  \u203A  ${sc.name}`;
    const t=this.P.wordsPerScene;
    $('sctgt').textContent=t>0?`(target: ~${t.toLocaleString()} words)`:'';
    $('sc-note').value=sc.note||'';
    $('ch-note').value=ch.note||'';
    $('pr-note').value=this.P.projectNote||'';
    this.renderTree(); this.updStatus(); this.updStats(); this.checkGrammar();
  },
  saveContent() {
    if (!this.cur||!this.P) return;
    this.P.chapters[this.cur.ci].scenes[this.cur.si].content = this.getEditorText();
  },

  // ── iframe editor helpers ──
  edBody() {
    const f=$('editor-frame');
    return f && f.contentDocument && f.contentDocument.body ? f.contentDocument.body : null;
  },
  edDoc() {
    const f=$('editor-frame');
    return f && f.contentDocument ? f.contentDocument : null;
  },
  getEditorText() {
    const b=this.edBody();
    if(!b) return '';
    return toText(b);
  },
  setEditorContent(text) {
    const doc=this.edDoc();
    if(!doc) return;
    doc.body.innerHTML = text ? toHTML(text) : '<div><br></div>';
  },
  edExecCmd(cmd, val) {
    const doc=this.edDoc();
    if(!doc) return;
    doc.execCommand(cmd, false, val||null);
    const f=$('editor-frame'); if(f) f.contentWindow.focus();
  },
  initEditorFrame() {
    const f=$('editor-frame');
    if(!f) return;
    const doc=f.contentDocument;
    doc.open();
    doc.write(`<!DOCTYPE html><html><head><style>
      html,body{margin:0;padding:0;background:transparent;}
      body{
        font-family:'Courier New',monospace;
        font-size:16px;line-height:1.9;color:#000;
        word-wrap:break-word;overflow-wrap:break-word;
        padding:0;min-height:100%;cursor:text;
        outline:none;
      }
      div{min-height:1.9em;}
    </style></head><body spellcheck="true" lang="en-US" contenteditable="true"></body></html>`);
    doc.close();
    doc.body.addEventListener('input', ()=>{
      if(!this.cur) return;
      this.saveContent(); this.setMod(true);
      this.updStatus(); this.refreshWC(); this.updStats(); this.checkGrammar();
    });
    doc.body.addEventListener('keydown', e=>{
      if(e.key==='Tab'){e.preventDefault();doc.execCommand('insertText',false,'    ');}
    });
    // Auto-resize iframe to content height
    const resize=()=>{
      f.style.height=(doc.body.scrollHeight+40)+'px';
    };
    doc.body.addEventListener('input', resize);
    // Initial size
    f.style.height='600px';
  },

  // ── Editor ──
  bindEditor() {
    // iframe is initialized in initEditorFrame() called from init()
    $('sc-note').addEventListener('input',()=>{
      if (!this.cur) return;
      this.P.chapters[this.cur.ci].scenes[this.cur.si].note=$('sc-note').value; this.setMod(true);
    });
    $('ch-note').addEventListener('input',()=>{
      if (!this.cur) return;
      this.P.chapters[this.cur.ci].note=$('ch-note').value; this.setMod(true);
    });
    $('pr-note').addEventListener('input',()=>{
      if (!this.P) return;
      this.P.projectNote=$('pr-note').value; this.setMod(true);
    });
  },
  refreshWC() {
    if (!this.cur) return;
    const {ci,si}=this.cur;
    const scEls=document.querySelectorAll(`#sl-${ci} .scitm`);
    if (scEls[si]) scEls[si].querySelector('.sw').textContent=countW(this.getEditorText());
    const chLbls=document.querySelectorAll('.chlbl');
    if (chLbls[ci]) chLbls[ci].querySelector('.cw').textContent=this.chWC(ci);
    this.updFooter();
  },
  updStatus() {
    if (!this.P) return;
    const swc=this.cur?countW(this.getEditorText()):0;
    const tot=this.totalWC(), tgt=this.P.targetWords;
    const cwc=this.cur?this.chWC(this.cur.ci):0;
    $('sb-sc').textContent =swc.toLocaleString();
    $('sb-ch').textContent =cwc.toLocaleString();
    $('sb-tot').textContent=tot.toLocaleString();
    $('sb-tgt').textContent=tgt>0?tgt.toLocaleString():'—';
    $('sb-pct').textContent=tgt>0?Math.round(tot/tgt*100)+'%':'—';
    $('sb-tot').classList.toggle('over',tgt>0&&tot>tgt);
  },
  updatePD() {
    if (!this.P){$('proj-disp').textContent='— No Project Open —';return;}
    $('proj-disp').textContent=`${this.P.title}  ·  ${this.P.author}`;
    $('tb-txt').textContent=`NovelStar 1.1 — ${this.P.title}`;
  },
  setMod(v) { this.mod=v; $('sbmod').classList.toggle('hidden',!v); },

  // ── Toolbar ──
  bindToolbar() {
    $('tb-bold').onclick =()=>this.edExecCmd('bold');
    $('tb-ital').onclick =()=>this.edExecCmd('italic');
    $('tb-ul').onclick   =()=>this.edExecCmd('underline');
    $('tb-left').onclick =()=>this.edExecCmd('justifyLeft');
    $('tb-ctr').onclick  =()=>this.edExecCmd('justifyCenter');
    $('tb-right').onclick=()=>this.edExecCmd('justifyRight');
    $('tb-sz').addEventListener('change',e=>{
      const doc=this.edDoc();
      if(doc) doc.body.style.fontSize=e.target.value+'px';
      $('fsed').style.fontSize=(parseInt(e.target.value)+4)+'px';
    });
    $('tb-font').addEventListener('change',e=>{
      const doc=this.edDoc();
      if(doc) doc.body.style.fontFamily=e.target.value;
    });
    $('tb-tab').onclick   =()=>this.edExecCmd('insertText','    ');
  },
  renameScene(ci,si) {
    const sc=this.P.chapters[ci].scenes[si];
    const n=prompt('Rename scene:',sc.name);
    if(n?.trim()){
      sc.name=n.trim(); this.setMod(true); this.renderTree();
      if(this.isCur(ci,si)) $('sclbl').textContent=`${this.P.chapters[ci].name}  \u203A  ${sc.name}`;
    }
  },

  // ── Left Panel Scene Buttons ──
  bindLPanel() {
    $('lp-newsc').onclick = () => this.newScene();
    $('lp-delsc').onclick = () => this.deleteScene();
    $('lp-rename').onclick = () => { if(this.cur) this.renameScene(this.cur.ci, this.cur.si); else this.toast('Select a scene first.'); };
  },
  recalcWordsPerScene() {
    if(!this.P) return;
    const totalScenes=this.P.chapters.reduce((s,ch)=>s+ch.scenes.length,0);
    this.P.wordsPerScene=totalScenes>0&&this.P.targetWords>0?Math.round(this.P.targetWords/totalScenes):0;
  },
  newScene() {
    if(!this.P){this.toast('No project open.');return;}
    if(!this.cur){this.toast('Select a chapter first.');return;}
    const ci=this.cur.ci;
    const ch=this.P.chapters[ci];
    const idx=ch.scenes.length+1;
    ch.scenes.push({name:`Scene ${idx}`,content:'',note:''});
    this.recalcWordsPerScene();
    this.setMod(true);
    this.renderTree();
    this.selectScene(ci, ch.scenes.length-1);
    this.toast('New scene added!');
  },
  deleteScene() {
    if(!this.P){this.toast('No project open.');return;}
    if(!this.cur){this.toast('Select a scene first.');return;}
    const {ci,si}=this.cur;
    const ch=this.P.chapters[ci];
    if(ch.scenes.length<=1){this.toast('Cannot delete the only scene in a chapter.');return;}
    if(!confirm(`Delete "${ch.scenes[si].name}"? This cannot be undone.`)) return;
    ch.scenes.splice(si,1);
    this.recalcWordsPerScene();
    this.cur=null;
    this.setMod(true);
    this.renderTree();
    const newSi=Math.min(si, ch.scenes.length-1);
    this.selectScene(ci, newSi);
    this.toast('Scene deleted.');
  },

  // ── Auto-Save ──
  bindAutoSave() {
    $('as-yes').onclick = () => {
      $('asmodal').classList.add('hidden');
      this.setAutoSave(true);
    };
    $('as-no').onclick = () => $('asmodal').classList.add('hidden');
    $('as-x').onclick  = () => $('asmodal').classList.add('hidden');
    $('autosave-chk').addEventListener('change', e => this.setAutoSave(e.target.checked));
  },
  promptAutoSave() {
    if (this.autoSave) return; // already on, no need to prompt
    $('asmodal').classList.remove('hidden');
  },
  setAutoSave(enabled) {
    this.autoSave = enabled;
    $('autosave-chk').checked = enabled;
    if (this.autoSaveTimer) { clearInterval(this.autoSaveTimer); this.autoSaveTimer = null; }
    if (enabled) {
      this.autoSaveTimer = setInterval(() => this.doAutoSave(), this.AUTO_SAVE_INTERVAL);
      this.toast('Auto-save enabled (every 60s)');
    } else {
      this.toast('Auto-save disabled');
    }
  },
  async doAutoSave() {
    if (!this.P || !this.mod) return;
    if (this.fh) {
      try {
        const w = await this.fh.createWritable();
        await w.write(this.toJSON());
        await w.close();
        this.setMod(false);
        this.flashAutoSave('Auto-saved ✓');
      } catch(e) { this.flashAutoSave('Auto-save failed'); }
    } else {
      // No file handle yet — silently skip (can't auto-save a brand-new unsaved project)
      this.flashAutoSave('Auto-save: save file first');
    }
  },
  flashAutoSave(msg) {
    const el = $('autosave-status');
    el.textContent = msg;
    el.style.opacity = '1';
    setTimeout(() => { el.style.opacity = '0'; }, 2500);
  },

  // ── File Ops ──
  async openFile() {
    if ('showOpenFilePicker' in window) {
      try {
        const [h]=await window.showOpenFilePicker({types:[{description:'NovelStar Project',accept:{'application/octet-stream':['.ns']}}]});
        this.loadText(await(await h.getFile()).text(),h);
      } catch(e){if(e.name!=='AbortError') $('file-in').click();}
    } else { $('file-in').click(); }
  },
  bindFileInput() {
    $('file-in').addEventListener('change',async e=>{
      const f=e.target.files[0]; if(!f) return;
      this.loadText(await f.text(),null); e.target.value='';
    });
  },
  loadText(text,handle) {
    try {
      const d=JSON.parse(text);
      if(!d.title||!d.chapters) throw new Error('Invalid .NS file');
      this.P=d; this.fh=handle; this.cur=null; this.setMod(false);
      $('splash').classList.add('hidden'); this.showApp();
      this.renderTree(); this.updatePD(); this.updStatus();
      if(this.P.chapters[0]?.scenes[0]) this.selectScene(0,0);
      this.toast('Project loaded!');
      setTimeout(()=>this.promptAutoSave(), 400);
    } catch(e){alert('Error: '+e.message);}
  },
  toJSON() { this.saveContent(); return JSON.stringify(this.P,null,2); },
  async save() {
    if (!this.P){this.toast('No project open.');return;}
    if (this.fh) {
      try {
        const w=await this.fh.createWritable(); await w.write(this.toJSON()); await w.close();
        this.setMod(false); this.toast('Saved!');
      } catch(e){this.saveAs();}
    } else {this.saveAs();}
  },
  async saveAs() {
    if (!this.P){this.toast('No project open.');return;}
    const text=this.toJSON();
    if ('showSaveFilePicker' in window) {
      try {
        const h=await window.showSaveFilePicker({
          suggestedName:this.P.title.replace(/\s+/g,'_')+'.ns',
          types:[{description:'NovelStar Project',accept:{'application/octet-stream':['.ns']}}]
        });
        const w=await h.createWritable(); await w.write(text); await w.close();
        this.fh=h; this.setMod(false); this.toast('Saved as .NS!');
      } catch(e){if(e.name!=='AbortError') this.fallback(text);}
    } else {this.fallback(text);}
  },
  fallback(text) {
    const a=document.createElement('a');
    a.href='data:application/octet-stream;charset=utf-8,'+encodeURIComponent(text);
    a.download=(this.P.title.replace(/\s+/g,'_')||'project')+'.ns';
    a.click(); this.setMod(false); this.toast('Downloaded .NS file!');
  },

  // ── Fullscreen ──
  bindFS() {
    $('fsexit').onclick=()=>this.exitFS();
    const fe=$('fsed');
    fe.addEventListener('input',()=>{
      if(!this.cur) return;
      const txt=toText(fe);
      this.P.chapters[this.cur.ci].scenes[this.cur.si].content=txt;
      this.setEditorContent(txt);
      this.setMod(true); this.updFSStatus(); this.refreshWC(); this.updStatus();
    });
    fe.addEventListener('keydown',e=>{
      if(e.key==='Tab'){e.preventDefault();document.execCommand('insertText',false,'    ');}
    });
  },
  enterFS() {
    if(!this.cur){this.toast('Select a scene first.');return;}
    this.saveContent();
    const txt=this.P.chapters[this.cur.ci].scenes[this.cur.si].content;
    $('fsed').innerHTML=toHTML(txt);
    this.updFSStatus();
    $('fsov').classList.add('active');
    setTimeout(()=>$('fsed').focus(),50);
  },
  exitFS() {
    $('fsov').classList.remove('active');
    if(this.cur){
      const txt=toText($('fsed'));
      this.P.chapters[this.cur.ci].scenes[this.cur.si].content=txt;
      this.setEditorContent(txt);
      this.updStatus(); this.refreshWC();
    }
  },
  updFSStatus() {
    $('fs-sc').textContent=countW(toText($('fsed'))).toLocaleString();
    $('fs-tot').textContent=this.totalWC().toLocaleString();
    $('fs-tgt').textContent=this.P?this.P.targetWords.toLocaleString():'—';
  },

  // ── Grammar / Spell check bar ──
  gramRules: [
    {re:/\b(teh|hte|adn|nad|taht|thta|wiht|waht|recieve|beleive|occured|seperate|definately|accomodate|neccessary|occurence|publically|persue|existance|independance|occurance|untill|alot)\b/gi, label:'Possible misspelling'},
    {re:/\b(i)\b(?!')/g, label:'"i" should be "I"'},
    {re:/\.\s+[a-z]/g, label:'Sentence may start with lowercase'},
    {re:/\b(its')\b/gi, label:'"its\'" — did you mean "its" or "it\'s"?'},
    {re:/\b(your|you're)\b/gi, test:(m,ctx)=>false}, // placeholder, too ambiguous
    {re:/\b(there|their|they're)\b/gi, test:(m,ctx)=>false},
    {re:/\b(a) ([aeiou])/gi, label:'"a" before vowel — consider "an"'},
    {re:/  +/g, label:'Double space'},
    {re:/\b(\w+)\s+\1\b/gi, label:'Repeated word'},
    {re:/[,;:][^ \n"']/g, label:'Missing space after punctuation'},
  ],
  checkGrammar() {
    const bar=$('grammarbar'), status=$('gram-status');
    if(!this.cur){bar.className='';status.textContent='Select a scene to begin';return;}
    const text=this.getEditorText();
    if(!text.trim()){bar.className='clean';status.textContent='Nothing to check yet';return;}
    const found=[];
    this.gramRules.forEach(rule=>{
      if(rule.test) return; // skip ambiguous rules
      const matches=text.match(rule.re);
      if(matches){
        const uniq=[...new Set(matches.map(m=>m.trim()))].slice(0,3);
        found.push({label:rule.label, examples:uniq});
      }
    });
    if(found.length===0){
      bar.className='clean';
      status.innerHTML='&#10003; No issues found';
    } else {
      bar.className='issues';
      status.innerHTML=found.map(f=>`<span class="gram-issue" title="${f.label}">${f.label}: <em>${f.examples.join(', ')}</em></span>`).join('');
    }
  },

  bindRTabs() {
    document.querySelectorAll('.rtab').forEach(tab=>{
      tab.onclick=()=>{
        document.querySelectorAll('.rtab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.rpane').forEach(p=>p.classList.remove('active'));
        tab.classList.add('active');
        $('tab-'+tab.dataset.tab).classList.add('active');
        if(tab.dataset.tab==='stats') this.updStats();
      };
    });
  },
  updStats() {
    if(!this.P) return;
    const tot=this.totalWC(), tgt=this.P.targetWords;
    const pct=tgt>0?Math.min(100,tot/tgt*100):0;
    const rem=tgt>0?Math.max(0,tgt-tot):0, over=tgt>0&&tot>tgt;
    const swc=this.cur?countW(this.getEditorText()):0;
    const rows=this.P.chapters.map((ch,ci)=>{
      const w=this.chWC(ci),ct=this.P.wordsPerScene*ch.scenes.length;
      return `<div class="srow"><span class="sl">${esc(ch.name)}</span><span class="sv${w>ct&&ct>0?' over':''}">${w.toLocaleString()}</span></div>`;
    }).join('');
    $('tab-stats').innerHTML=`
      <div style="font-weight:bold;font-size:14px;border-bottom:2px solid var(--bg);padding-bottom:4px;margin-bottom:4px;">Overall</div>
      <div class="srow"><span class="sl">Total Words</span><span class="sv${over?' over':''}">${tot.toLocaleString()}</span></div>
      <div class="srow"><span class="sl">Target</span><span class="sv">${tgt>0?tgt.toLocaleString():'—'}</span></div>
      <div class="srow"><span class="sl">Remaining</span><span class="sv">${tgt>0?rem.toLocaleString():'—'}</span></div>
      <div class="srow"><span class="sl">Progress</span><span class="sv">${tgt>0?pct.toFixed(1)+'%':'—'}</span></div>
      <div class="pout"><div class="pin${over?' over':''}" style="width:${pct}%">${pct>12?pct.toFixed(0)+'%':''}</div></div>
      <div class="srow"><span class="sl">Target/Scene</span><span class="sv">${this.P.wordsPerScene.toLocaleString()}</span></div>
      ${this.cur?`<div class="srow"><span class="sl">Scene Words</span><span class="sv">${swc.toLocaleString()}</span></div>`:''}
      <div style="font-weight:bold;font-size:14px;border-bottom:2px solid var(--bg);padding-bottom:4px;margin:8px 0 4px;">By Chapter</div>
      ${rows}`;
  },

  // ── Compile ──
  openCompile() {
    if(!this.P){this.toast('No project open.');return;}
    // Save current scene before opening compile dialog
    if(this.cur) {
      this.P.chapters[this.cur.ci].scenes[this.cur.si].content = this.getEditorText();
    }
    $('c-author').value=this.P.author;
    $('c-title').value=this.P.title;
    ['c-addr1','c-addr2','c-email','c-phone'].forEach(id=>$(id).value='');
    $('msprev').style.display='none'; $('msprev').innerHTML='';
    $('cmodal').classList.remove('hidden');
  },
  bindCompile() {
    $('cm-x').onclick    =()=>$('cmodal').classList.add('hidden');
    $('cm-close').onclick=()=>$('cmodal').classList.add('hidden');
    $('cm-prev').onclick =()=>this.buildPreview();
    $('cm-pdf').onclick  =()=>this.downloadPDF();
  },

  // Only chapters with content
  getActiveChapters() {
    this.saveContent();
    return this.P.chapters
      .filter(ch=>ch.scenes.some(sc=>sc.content.trim()))
      .map((ch,i)=>({...ch, displayNum: i+1}));
  },

  getMeta() {
    // Force-save current editor content before counting
    if(this.cur && this.P) {
      this.P.chapters[this.cur.ci].scenes[this.cur.si].content = this.getEditorText();
    }
    const total = this.totalWC();
    return {
      author: $('c-author').value.trim()||'Unknown Author',
      title:  $('c-title').value.trim()||'Untitled',
      addr1:  $('c-addr1').value.trim(),
      addr2:  $('c-addr2').value.trim(),
      email:  $('c-email').value.trim(),
      phone:  $('c-phone').value.trim(),
      approxWords: Math.max(total, Math.round(total/100)*100)
    };
  },

  // ── HTML Preview (looks like paper pages) ──
  buildPreview() {
    const {author,title,addr1,addr2,email,phone,approxWords}=this.getMeta();
    const active=this.getActiveChapters();
    const surname=author.split(' ').pop().toUpperCase();
    const shortT=title.toUpperCase().substring(0,20);
    let html='';

    // Page 1 — title page
    html+=`<div class="mspage">`;
    html+=`<div style="font-family:'Courier New',monospace;line-height:2;">`;
    html+=`${esc(author)}<br>`;
    if(addr1) html+=`${esc(addr1)}<br>`;
    if(addr2) html+=`${esc(addr2)}<br>`;
    if(email) html+=`${esc(email)}<br>`;
    if(phone) html+=`${esc(phone)}<br>`;
    html+=`</div>`;
    html+=`<div class="ms-wc-r">Approx. ${approxWords.toLocaleString()} words</div>`;
    html+=`<div class="ms-title-blk">
      <strong>${esc(title.toUpperCase())}</strong><br><br>
      by ${esc(author)}
    </div>`;
    html+=`</div>`;

    // One page per chapter
    active.forEach((ch,idx)=>{
      html+=`<div class="mspage">`;
      html+=`<div class="ms-hdr-r">${esc(surname)} / ${esc(shortT)} / ${idx+2}</div>`;
      html+=`<div class="ms-ch-blk"><strong>CHAPTER ${ch.displayNum}</strong></div>`;
      let first=true;
      ch.scenes.forEach(sc=>{
        const content=sc.content.trim(); if(!content) return;
        if(!first){
          html+=`<p class="ms-break">&nbsp;</p>`;
          html+=`<p class="ms-break">* &nbsp; * &nbsp; *</p>`;
          html+=`<p class="ms-break">&nbsp;</p>`;
        }
        first=false;
        content.split(/\n\n+/).forEach(para=>{
          const t=para.replace(/\n/g,' ').trim(); if(!t) return;
          html+=`<p class="ms-para">${esc(t)}</p>`;
        });
      });
      html+=`</div>`;
    });

    const box=$('msprev');
    box.innerHTML=html;
    box.style.display='block';
  },

  // ── PDF ──
  downloadPDF() {
    if(!window.jspdf){this.toast('PDF library loading, try again.');return;}
    const {jsPDF}=window.jspdf;
    const {author,title,addr1,addr2,email,phone,approxWords}=this.getMeta();
    const active=this.getActiveChapters();

    const PW=8.5,PH=11,ML=1,MR=1,MT=1,MB=1,TW=6.5,FS=12;
    const LSin=24/72; // double-spaced 12pt = 24pt line height = 24/72 inches

    const doc=new jsPDF({unit:'in',format:'letter',orientation:'portrait'});
    doc.setFont('Courier','normal'); doc.setFontSize(FS);

    let y=MT, pn=1;
    const surname=author.split(' ').pop().toUpperCase();
    const shortT=title.toUpperCase().substring(0,20);

    const drawHdr=()=>{
      const h=`${surname} / ${shortT} / ${pn}`;
      doc.setFont('Courier','normal'); doc.setFontSize(FS);
      doc.text(h, PW-MR-doc.getTextWidth(h), MT-0.3);
    };
    const newPage=()=>{
      doc.addPage(); pn++; y=MT;
      doc.setFont('Courier','normal'); doc.setFontSize(FS);
      drawHdr();
    };
    const chk=()=>{ if(y>PH-MB-LSin) newPage(); };
    const line=(txt,ind=0,ctr=false)=>{
      chk();
      if(ctr){const w=doc.getTextWidth(txt);doc.text(txt,ML+(TW-w)/2,y);}
      else{doc.text(txt,ML+ind,y);}
      y+=LSin;
    };
    const blank=()=>{chk();y+=LSin;};
    const wrap=(text,ind)=>{
      const av=TW-ind, words=text.split(' '), ls=[]; let cur='';
      words.forEach(w=>{
        const t=cur?cur+' '+w:w;
        if(doc.getTextWidth(t)<=av){cur=t;}else{if(cur)ls.push(cur);cur=w;}
      });
      if(cur)ls.push(cur); return ls;
    };

    // ── Page 1 title page ──
    const clines=[author];
    if(addr1)clines.push(addr1);
    if(addr2)clines.push(addr2);
    if(email)clines.push(email);
    if(phone)clines.push(phone);
    clines.forEach(cl=>{doc.text(cl,ML,y);y+=LSin;});
    const wcStr=`Approx. ${approxWords.toLocaleString()} words`;
    doc.text(wcStr,PW-MR-doc.getTextWidth(wcStr),MT);

    // Title block centered vertically on page 1
    y=PH/2-LSin;
    doc.setFont('Courier','bold'); doc.setFontSize(FS);
    const tTxt=title.toUpperCase();
    doc.text(tTxt,ML+(TW-doc.getTextWidth(tTxt))/2,y);
    y+=LSin*2;
    doc.setFont('Courier','normal');
    const byL='by '+author;
    doc.text(byL,ML+(TW-doc.getTextWidth(byL))/2,y);

    // ── Chapter pages ──
    active.forEach((ch,idx)=>{
      newPage();
      // Chapter heading 1/3 down the page body
      y=MT+(PH-MT-MB)*0.33;
      doc.setFont('Courier','bold'); doc.setFontSize(FS);
      const cht=`CHAPTER ${ch.displayNum}`;
      doc.text(cht,ML+(TW-doc.getTextWidth(cht))/2,y);
      doc.setFont('Courier','normal'); doc.setFontSize(FS);
      y+=LSin*2;

      let first=true;
      ch.scenes.forEach(sc=>{
        const content=sc.content.trim(); if(!content) return;
        if(!first){
          // Shunn scene break: "* * *" centered
          blank();
          const sep='* * *';
          chk(); doc.text(sep,ML+(TW-doc.getTextWidth(sep))/2,y); y+=LSin;
          blank();
        }
        first=false;
        content.split(/\n\n+/).forEach(para=>{
          const trimmed=para.replace(/\n/g,' ').trim(); if(!trimmed) return;
          const wrapped=wrap(trimmed,0.5);
          wrapped.forEach((wl,wi)=>{
            chk(); doc.text(wl,ML+(wi===0?0.5:0),y); y+=LSin;
          });
        });
      });
    });

    doc.save(title.replace(/[^a-zA-Z0-9]/g,'_')+'_manuscript.pdf');
    this.toast('PDF downloaded!');
  },

  toast(msg) {
    const t=$('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),2200);
  }
};

function $(id){return document.getElementById(id);}
function countW(t){if(!t||!t.trim())return 0;return t.trim().split(/\s+/).filter(w=>w.length>0).length;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// plain text -> contenteditable HTML
// Each paragraph becomes a <div>; empty lines become <div><br></div>
function toHTML(text){
  if(!text) return '';
  const lines = text.split('\n');
  return lines.map(line => {
    const escaped = line
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
    return `<div>${escaped || '<br>'}</div>`;
  }).join('');
}

// contenteditable -> plain text
function toText(el){
  let r='';
  const walk=n=>{
    if(n.nodeType===3){r+=n.textContent;}
    else if(n.nodeType===1){
      const tag=n.tagName.toLowerCase();
      if(tag==='br'){
        // Only add newline for <br> that is the sole child of a div (empty line placeholder)
        if(n.parentNode && n.parentNode.tagName && n.parentNode.tagName.toLowerCase()==='div' && n.parentNode.childNodes.length===1){
          r+='\n';
        }
        return;
      }
      if(['p','div'].includes(tag)&&r.length>0&&!r.endsWith('\n')) r+='\n';
      n.childNodes.forEach(walk);
      if(['p','div'].includes(tag)&&!r.endsWith('\n')) r+='\n';
    }
  };
  el.childNodes.forEach(walk);
  return r.replace(/\n{3,}/g,'\n\n').trim();
}

NS.init();
</script>
</body>
</html>
